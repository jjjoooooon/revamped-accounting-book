generator client {
  provider        = "prisma-client-js"
  engineType      = "library"
  // Enable views if you plan to use database views for complex dashboard stats
  previewFeatures = ["views"] 
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  password      String?
  role          String    @default("user")
  status        String    @default("pending")

  // Indexes for admin panel filtering
  @@index([role])
  @@index([status])
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budgetLimit Float     @default(0)
  color       String?   @default("emerald")
  expenses    Expense[]
  income      Income[]
}

model Expense {
  id          String   @id @default(cuid())
  amount      Float
  description String?
  date        DateTime @default(now())
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id])

  // Optimization: Foreign Key & Date filtering
  @@index([categoryId])
  @@index([date])
}

model Income {
  id          String   @id @default(cuid())
  amount      Float
  description String?
  date        DateTime @default(now())
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id])

  // Optimization: Foreign Key & Date filtering
  @@index([categoryId])
  @@index([date])
}

model Invoice {
  id         String    @id @default(cuid())
  invoiceNo  String    @unique
  amount     Float
  status     String    @default("pending")
  dueDate    DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  memberId   String
  paidAmount Float     @default(0)
  period     String?
  type       String    @default("Sanda")
  member     Member    @relation(fields: [memberId], references: [id])
  payments   Payment[]

  // Optimization: Critical for dashboard "Pending vs Paid" stats
  @@index([memberId])
  @@index([status])
  @@index([dueDate])
  @@index([type])
}

model Payment {
  id            String       @id @default(cuid())
  invoiceId     String
  amount        Float
  date          DateTime     @default(now())
  method        String
  bankAccountId String?
  createdAt     DateTime     @default(now())
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  invoice       Invoice      @relation(fields: [invoiceId], references: [id])

  // Optimization: Linking payments to banks/invoices
  @@index([invoiceId])
  @@index([bankAccountId])
  @@index([date])
}

model Member {
  id               String     @id @default(cuid())
  name             String
  address          String?
  email            String?
  contact          String
  paymentFrequency String     @default("Monthly")
  amountPerCycle   Float      @default(0)
  startDate        DateTime   @default(now())
  profilePicture   String?
  status           String     @default("active")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  donations        Donation[]
  invoices         Invoice[]

  // Optimization: Searching members by contact/status
  @@index([status])
  @@index([contact])
}

model Donation {
  id            String   @id @default(cuid())
  amount        Float
  date          DateTime @default(now())
  purpose       String
  paymentMethod String
  isAnonymous   Boolean  @default(false)
  donorType     String
  donorName     String?
  memberId      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  member        Member?  @relation(fields: [memberId], references: [id])

  // Optimization: Reporting on donations
  @@index([memberId])
  @@index([date])
  @@index([donorType])
}

model BankAccount {
  id            String    @id @default(cuid())
  bankName      String
  accountName   String
  accountNumber String
  branch        String?
  type          String
  balance       Float     @default(0)
  status        String    @default("Active")
  color         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  transactions  Ledger[]
  payments      Payment[]
}

model Ledger {
  id            String       @id @default(cuid())
  date          DateTime     @default(now())
  description   String
  amount        Float
  type          String
  category      String?
  bankAccountId String?
  referenceId   String?
  referenceType String?
  createdAt     DateTime     @default(now())
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])

  // Optimization: General Ledger filtering
  @@index([bankAccountId])
  @@index([date])
  @@index([type])
  // Composite index: Super fast for finding "Related Transactions" (Polymorphic lookups)
  @@index([referenceType, referenceId])
}